<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gráficos de Registro de Causas</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f7fb;
      color: #2c3e50;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #1f3a93;
      margin-bottom: 30px;
    }
    .chart-container {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin: 20px auto;
      max-width: 900px;
    }
    canvas {
      max-height: 400px;
    }
    .resumen {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
      color: #34495e;
    }
  </style>
</head>
<body>
  <h1>📊 Estadísticas de Registro de Causas</h1>

  <div class="chart-container">
    <h2>Por Estado</h2>
    <canvas id="chartEstado"></canvas>
    <div id="resEstado" class="resumen"></div>
  </div>

  <div class="chart-container">
    <h2>Por Tipo de Proceso</h2>
    <canvas id="chartTipo"></canvas>
    <div id="resTipo" class="resumen"></div>
  </div>

  <div class="chart-container">
    <h2>Por Juzgado</h2>
    <canvas id="chartJuzgado"></canvas>
    <div id="resJuzgado" class="resumen"></div>
  </div>

  <div class="chart-container">
    <h2>Por Usuario Asignado</h2>
    <canvas id="chartUsuario"></canvas>
    <div id="resUsuario" class="resumen"></div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 🔑 Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
      authDomain: "causas-defensoria.firebaseapp.com",
      projectId: "causas-defensoria",
      storageBucket: "causas-defensoria.firebasestorage.app",
      messagingSenderId: "186064671470",
      appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 🎨 Función de color gradiente según cantidad
    function colorPorCantidad(valor, maximo) {
      if (valor <= 1) return "#2ecc71"; // Verde
      const ratio = valor / maximo;
      if (ratio < 0.4) return "#f1c40f"; // Amarillo
      if (ratio < 0.7) return "#e67e22"; // Naranja
      return "#e74c3c"; // Rojo
    }

    // ⚙️ Crear gráfico base
    function crearGrafico(ctx, titulo) {
      return new Chart(ctx, {
        type: "bar",
        data: {
          labels: [],
          datasets: [{
            label: titulo,
            data: [],
            backgroundColor: []
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          },
          scales: {
            y: {
              beginAtZero: false,
              min: 1,
              ticks: {
                stepSize: 1 // 🔹 Escala enumerada (1, 2, 3…)
              },
              title: { display: true, text: "Cantidad" }
            },
            x: {
              title: { display: true, text: titulo }
            }
          }
        }
      });
    }

    // 🏗️ Crear gráficos
    const chartEstado = crearGrafico(document.getElementById("chartEstado"), "Estados");
    const chartTipo = crearGrafico(document.getElementById("chartTipo"), "Tipos de Proceso");
    const chartJuzgado = crearGrafico(document.getElementById("chartJuzgado"), "Juzgados");
    const chartUsuario = crearGrafico(document.getElementById("chartUsuario"), "Usuarios");

    // 📊 Contar ocurrencias por campo
    function contarPorCampo(arr, campo) {
      const conteo = {};
      arr.forEach(d => {
        const valor = d[campo] || "Sin dato";
        conteo[valor] = (conteo[valor] || 0) + 1;
      });
      return conteo;
    }

    // 🔄 Actualizar gráfico + resumen
    function actualizar(chart, conteo, resumenEl) {
      const etiquetas = Object.keys(conteo);
      const valores = Object.values(conteo);
      const maximo = Math.max(...valores, 1);

      const colores = valores.map(v => colorPorCantidad(v, maximo));

      chart.data.labels = etiquetas;
      chart.data.datasets[0].data = valores;
      chart.data.datasets[0].backgroundColor = colores;
      chart.update();

      const total = valores.reduce((a,b) => a+b, 0);
      const idxMax = valores.indexOf(maximo);
      const etiquetaMax = etiquetas[idxMax] || "N/A";

      resumenEl.textContent = `Total: ${total} expedientes | Máximo: ${etiquetaMax} = ${maximo}`;
    }

    // 🔥 Escuchar Firestore
    onSnapshot(collection(db, "causas"), (snap) => {
      const datos = [];
      snap.forEach(doc => datos.push(doc.data()));

      actualizar(chartEstado, contarPorCampo(datos, "estado"), document.getElementById("resEstado"));
      actualizar(chartTipo, contarPorCampo(datos, "tipoProceso"), document.getElementById("resTipo"));
      actualizar(chartJuzgado, contarPorCampo(datos, "juzgado"), document.getElementById("resJuzgado"));
      actualizar(chartUsuario, contarPorCampo(datos, "usuarioAsignado"), document.getElementById("resUsuario"));
    });
  </script>
</body>
</html>
