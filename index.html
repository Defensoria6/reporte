<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estadisticas del Sistema</title>
  <style>
    :root {
      --bg: #f0f4f8;
      --fg: #2c3e50;
      --card: #ffffff;
      --brand: #2980b9;
      --accent: #3498db;
      --text-muted: #7f8c8d;
    }
    html, body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header { padding: 24px 20px; text-align: center; }
    h1 { margin: 0; color: var(--brand); font-weight: 800; letter-spacing: -0.5px; font-size: 2.2rem; }
    .filters { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; margin-top: 24px; }
    .filter-group { display: flex; align-items: center; gap: 8px; }
    select {
      padding: 8px 12px; border-radius: 10px; border: 1px solid #d3dce6; background: var(--card);
      color: var(--fg); font-size: 1rem; transition: all 0.2s ease-in-out;
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%237f8c8d"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>');
      background-repeat: no-repeat; background-position: right 12px center; background-size: 1.2em;
    }
    select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
    main { display: flex; flex-direction: column; align-items: center; padding: 30px; }
    .card {
      width: 100%; max-width: 600px; background: var(--card); border-radius: 16px;
      box-shadow: 0 8px 25px rgba(20, 25, 35, 0.08); padding: 20px;
    }
    .card h3 { margin: 0 0 8px; color: var(--accent); font-size: 1.1rem; text-align: center; font-weight: 700; }
    .total { font-weight: 800; font-size: 2rem; color: var(--fg); text-align: center; margin-bottom: 12px; }
    .chart { height: 350px; position: relative; }
    .loading-overlay, .no-data-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.85);
      display: flex; justify-content: center; align-items: center; z-index: 10;
      border-radius: 16px; text-align: center; flex-direction: column;
    }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tooltip { position: absolute; background: #333; color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; pointer-events: none; opacity: 0; transition: opacity 0.2s ease-in-out; z-index: 20; }
    .buttons-container { text-align: center; margin: 24px; padding-bottom: 30px; }
    .btn { background: var(--brand); color: #fff; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: background 0.2s ease-in-out, transform 0.2s ease-in-out; margin: 0 8px; }
    .btn:hover { background: #1f5682; transform: translateY(-2px); }
    .chart-legend { display: flex; flex-direction: column; align-items: center; margin-top: 15px; font-size: 0.9em; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin: 2px 0; color: var(--text-muted); }
    .legend-color { width: 12px; height: 12px; border-radius: 50%; }
    @media (max-width: 480px) { .filters { flex-direction: column; align-items: stretch; } }
    @media print { .filters, .buttons-container { display: none; } body { background: #fff; } .card { box-shadow: none; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // === Configuración de las dos bases de datos (SIN CAMBIOS) ===
    const firebaseConfigCausas = {
      apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
      authDomain: "causas-defensoria.firebaseapp.com",
      projectId: "causas-defensoria",
      storageBucket: "causas-defensoria.firebasestorage.app",
      messagingSenderId: "186064671470",
      appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
    };
    const firebaseConfigAtencion = {
      apiKey: "AIzaSyDgxLS98sk6GkLrjMu3BVS2cmZ9exdh4dY",
      authDomain: "atencion-publico-def6.firebaseapp.com",
      projectId: "atencion-publico-def6",
      storageBucket: "atencion-publico-def6.firebasestorage.app",
      messagingSenderId: "1052433106688",
      appId: "1:1052433106688:web:8ac3e144bcf377ac4b55e5"
    };

    const appCausas = initializeApp(firebaseConfigCausas, "causasApp");
    const appAtencion = initializeApp(firebaseConfigAtencion, "atencionApp");
    const dbCausas = getFirestore(appCausas);
    const dbAtencion = getFirestore(appAtencion);

    // === Estado (manteniendo la lógica original) ===
    let datosCacheCausas = null;   // se completa por Firebase
    let datosCacheAtencion = null; // se completa por Firebase

    // Fuentes externas JSON (inicializadas como listas vacías para que el tablero cargue aunque falten)
    let datosCacheCCyC = [];       // se completa por fetch, pero nunca bloquea
    let datosCacheModo = [];       // se completa por fetch, pero nunca bloquea

    const loadingOverlay = document.getElementById("loading");
    const noDataOverlay = document.getElementById("no-data");

    // === Paletas de colores (sin cambios para las claves existentes) ===
    const colorScales = {
      estado: d3.scaleOrdinal(d3.schemePaired),
      prioridad: d3.scaleOrdinal(d3.schemeSet1),
      intervencion: d3.scaleOrdinal(d3.schemeSet2),
      audiencias: d3.scaleOrdinal(d3.schemeOranges[7]),
      gesel: d3.scaleOrdinal(d3.schemeGreens[7]),
      vencimiento: d3.scaleOrdinal(d3.schemePurples[7]),
      recursos: d3.scaleOrdinal(d3.schemeSet1),
      usuarioAsignado: d3.scaleOrdinal(d3.schemeSet3),
      type: d3.scaleOrdinal(["#34c759", "#ff9500", "#af52de"]), // Atención al público
      generic: d3.scaleOrdinal(d3.schemeTableau10) // respaldo para externos
    };

    // === Lista de gráficos disponibles (igual + dos nuevas entradas externas) ===
    const chartsData = [
      { id: "estado", name: "Estado", key: "estado", source: "causas" },
      { id: "prioridad", name: "Prioridad", key: "prioridad", source: "causas" },
      { id: "intervencion", name: "Intervención", key: "intervencion", source: "causas" },
      { id: "audiencias", name: "Audiencias", key: "audiencias", dateFilter: true, source: "causas" },
      { id: "gesel", name: "Audiencia Gesel", key: "gesel", dateFilter: true, source: "causas" },
      { id: "vencimiento", name: "Vencimientos", key: "vencimiento", dateFilter: true, source: "causas" },
      { id: "recursos", name: "Recursos", key: "recursos", source: "causas" },
      { id: "usuarioAsignado", name: "Usuario Asignado", key: "usuarioAsignado", source: "causas" },
      { id: "atencion", name: "Atención al Público", key: "type", source: "atencion" },
      // Nuevos (externos) — mismos estilos y lógica visual
      { id: "ccyc_estados", name: "Art. 583 CCyC – Estados", key: "estado", source: "ccyc" },
      { id: "modo_estados", name: "Modo de intervención – Estados", key: "estado", source: "modo" }
    ];

    // === Crear gráfico de dona (igual al original) ===
    function crearGraficoTorta(id){
      d3.select(id).select("svg").remove();
      const svg = d3.select(id).append("svg")
        .attr("width", "100%").attr("height", "100%")
        .attr("viewBox", "0 0 350 350").attr("preserveAspectRatio", "xMidYMid meet");
      const g = svg.append("g").attr("transform", "translate(175, 175)");
      const radius = Math.min(350, 350) / 2 - 20;
      const arc = d3.arc().innerRadius(radius * 0.6).outerRadius(radius);
      const pie = d3.pie().value(d => d.v).sort(null);
      const tooltip = d3.select("body").append("div").attr("class", "tooltip");
      return { svg, g, arc, pie, radius, tooltip };
    }

    // === Actualizar gráfico de dona (igual al original) ===
    function actualizarGraficoTorta(chart, data, key, colorKey, totalId){
      const agg = d3.rollups(data, d => d.length, d => d[key] || "Sin dato").map(([k, v]) => ({ k, v }));
      const total = d3.sum(agg, d => d.v);
      document.getElementById(totalId).textContent = total;

      const arcs = chart.g.selectAll(".arc").data(chart.pie(agg), d => d.data.k);
      arcs.exit().remove();

      const newArcs = arcs.enter().append("g").attr("class", "arc");
      newArcs.append("path")
        .attr("fill", d => (colorScales[colorKey] || colorScales.generic)(d.data.k))
        .transition().duration(750).attrTween("d", function(d){
            const i = d3.interpolate(d.startAngle, d.endAngle);
            return function(t){
                d.endAngle = i(t);
                return chart.arc(d);
            };
        });

      arcs.select("path").transition().duration(750).attr("d", chart.arc);

      // Actualizar Leyenda
      const legendContainer = d3.select("#chart-legend");
      const legendData = agg.sort((a,b) => d3.descending(a.v,b.v));
      const legendItems = legendContainer.selectAll(".legend-item").data(legendData, d => d.k);
      legendItems.exit().remove();
      const newLegendItems = legendItems.enter().append("div").attr("class", "legend-item");
      newLegendItems.append("span").attr("class", "legend-color").style("background-color", d => (colorScales[colorKey] || colorScales.generic)(d.k));
      newLegendItems.append("span").text(d => `${d.k}: ${total>0 ? d3.format(".1%")(d.v / total) : "0.0%"}`);
      legendItems.select("span:last-child").text(d => `${d.k}: ${total>0 ? d3.format(".1%")(d.v / total) : "0.0%"}`);
    }

    // === Instancia de gráfico único (igual) ===
    let chPrincipal = null;

    // === Lógica de rangos (igual al original) ===
    const selRango = document.getElementById("filtroRango");
    function obtenerDias(){
      if(selRango.value==="semana") return 7;
      if(selRango.value==="mes") return 30;
      if(selRango.value==="anio") return 365;
      return 30;
    }
    function fechaValidaEnRango(valor){
      const dias = obtenerDias();
      if(!valor) return false;
      const hoy = new Date();
      const limite = new Date(hoy); limite.setDate(hoy.getDate() + dias);
      const toDate = (v) => v && typeof v==="object" && "seconds" in v ? new Date(v.seconds * 1000) : new Date(v);
      const d = toDate(valor);
      return !isNaN(d) && d >= hoy && d <= limite;
    }
    function obtenerCampo(obj, posibles){
      for(const k of posibles){ if(k in obj && obj[k] != null) return obj[k]; }
      return null;
    }

    // === Render igual al original, con soporte para fuentes externas ===
    function actualizarDashboard(){
      // El tablero se muestra cuando llegan LAS bases Firebase, como el original
      if (datosCacheCausas === null || datosCacheAtencion === null) return;

      loadingOverlay.style.display = "none";
      if(!chPrincipal) chPrincipal = crearGraficoTorta("#mainChart");

      const selectedChartId = document.getElementById("chartSelector").value;
      const chartConfig = chartsData.find(c => c.id === selectedChartId);

      let data = [];
      if(chartConfig.source === "atencion"){
        data = datosCacheAtencion;
        document.getElementById("filtroRango").style.display = "none";
      } else if (chartConfig.source === "causas") {
        data = datosCacheCausas;
        document.getElementById("filtroRango").style.display = "block";
        if(chartConfig.dateFilter){
          data = data.filter(d => fechaValidaEnRango(obtenerCampo(d, [chartConfig.key])));
        }
      } else if (chartConfig.source === "ccyc") {
        // externos: si no hay datos aún, data = []
        data = datosCacheCCyC;
        document.getElementById("filtroRango").style.display = "none";
      } else if (chartConfig.source === "modo") {
        data = datosCacheModo;
        document.getElementById("filtroRango").style.display = "none";
      }

      document.getElementById("chartTitle").textContent = chartConfig.name;

      if (data.length > 0) {
        noDataOverlay.style.display = "none";
        actualizarGraficoTorta(chPrincipal, data, chartConfig.key, chartConfig.key, "totalGeneral");
      } else {
        noDataOverlay.style.display = "flex";
        d3.select("#mainChart svg").remove();
        d3.select("#chart-legend").selectAll("*").remove();
        document.getElementById("totalGeneral").textContent = "0";
        chPrincipal = null;
      }
    }

    // === Filtros (igual) ===
    const chartSelector = document.getElementById("chartSelector");
    chartSelector.onchange = actualizarDashboard;
    selRango.onchange = actualizarDashboard;

    // Poblar selector (igual) + nuevas opciones
    chartsData.forEach(c => {
      const o = document.createElement("option");
      o.value = c.id;
      o.textContent = c.name;
      chartSelector.appendChild(o);
    });

    // === Suscripción Firestore (igual al original) ===
    loadingOverlay.style.display = "flex";
    noDataOverlay.style.display = "none";

    onSnapshot(query(collection(dbCausas, "causas")), snap => {
      const arr = [];
      snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
      datosCacheCausas = arr;
      actualizarDashboard();
    }, err => {
      console.error("Error al obtener datos de causas:", err);
      datosCacheCausas = []; // si falla, no bloquea el tablero
      actualizarDashboard();
    });

    onSnapshot(query(collection(dbAtencion, "atencion")), snap => {
      const arr = [];
      snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
      datosCacheAtencion = arr;
      actualizarDashboard();
    }, err => {
      console.error("Error al obtener datos de atenciones:", err);
      datosCacheAtencion = []; // si falla, no bloquea
      actualizarDashboard();
    });

    // === Carga resiliente de JSON externos (NO bloquea la UI) ===
    const urlsExternas = {
      ccyc: "https://defensoria6.github.io/583ccyc/data.json",
      modo: "https://defensoria6.github.io/modo-intervencion/data.json"
    };

    function expandirEstadosDesdeConteos(obj){
      const arr = [];
      const toInt = (x) => Number.isFinite(parseInt(x)) ? parseInt(x) : 0;
      const activos = toInt(obj?.activos);
      const cerrados = toInt(obj?.cerrados);
      const espera  = toInt(obj?.espera);
      if (activos > 0) arr.push(...Array(activos).fill({ estado: "Activo" }));
      if (cerrados > 0) arr.push(...Array(cerrados).fill({ estado: "Cerrado" }));
      if (espera  > 0) arr.push(...Array(espera ).fill({ estado: "En espera" }));
      return arr;
    }

    async function cargarExternos(){
      // CCyC
      try {
        const r1 = await fetch(urlsExternas.ccyc, { cache: "no-store" });
        if (r1.ok) {
          const j1 = await r1.json();
          datosCacheCCyC = expandirEstadosDesdeConteos(j1);
        } else {
          datosCacheCCyC = []; // sin datos/404 => vacío
        }
      } catch (e) {
        console.warn("CCyC sin datos o inaccesible:", e);
        datosCacheCCyC = []; // error => vacío
      }
      // Modo
      try {
        const r2 = await fetch(urlsExternas.modo, { cache: "no-store" });
        if (r2.ok) {
          const j2 = await r2.json();
          datosCacheModo = expandirEstadosDesdeConteos(j2);
        } else {
          datosCacheModo = [];
        }
      } catch (e) {
        console.warn("Modo sin datos o inaccesible:", e);
        datosCacheModo = [];
      }
      // No llamamos a loading aquí: la UI depende de Firebase como en el original
      actualizarDashboard(); // refresca si el usuario está mirando estas vistas
    }
    // Lanzamos la carga sin bloquear el arranque
    cargarExternos();

    // === Botones (igual) ===
    document.getElementById("btnPrintDashboard").onclick = () => window.print();
    document.getElementById("btnDownload").onclick = () => {
      const dashboard = document.getElementById("dashboard");
      html2canvas(dashboard, {
        allowTaint: true,
        useCORS: true,
        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg') || '#f0f4f8'
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'estadistica.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    };
  </script>
</head>
<body>
  <header>
    <h1>Estadísticas del Sistema</h1>
<h5>Diseño y programación de Rómulo Fioravante.Leg2481.Año 2025<h5>
    <div class="filters">
      <div class="filter-group">
        <label for="chartSelector">Gráfico a Mostrar</label>
        <select id="chartSelector"></select>
      </div>
      <div class="filter-group">
        <label for="filtroRango">Rango</label>
        <select id="filtroRango">
          <option value="semana">Semanal (7 días)</option>
          <option value="mes" selected>Mensual (30 días)</option>
          <option value="anio">Anual (365 días)</option>
        </select>
      </div>
    </div>
  </header>

  <main id="dashboard">
    <div class="card">
      <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
      </div>
      <div id="no-data" class="no-data-overlay" style="display:none;">
        <h3>No hay datos para mostrar en este gráfico.</h3>
      </div>
      <h3 id="chartTitle">Estado</h3>
      <div id="totalGeneral" class="total">0</div>
      <div id="mainChart" class="chart"></div>
      <div id="chart-legend" class="chart-legend"></div>
    </div>
  </main>

  <div class="buttons-container">
    <button id="btnPrintDashboard" class="btn">🖨️ Imprimir Estadistica</button>
    <button id="btnDownload" class="btn">⬇️ Descargar como Imagen</button>
  </div>
</body>
</html>
